{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Ideas Dashboard â€” List + Priority Matrix
  ============================================================
{% endcomment %}

<!-- Hero -->
<section class="hero">
  <div class="flex justify-between items-center flex-wrap gap-md">
    <div>
      <h1>AI Ideas Dashboard</h1>
      <p>Capture, evaluate, and prioritize AI use cases across the organization.</p>
    </div>
    <div class="flex gap-sm">
      <a href="/ideas/submit" class="btn btn-lg" style="background:#fff;color:var(--color-primary)">
        <i data-lucide="plus" style="width:18px;height:18px"></i> Submit Idea
      </a>
      <a href="/ideas/pipeline" class="btn btn-lg btn-ghost">
        <i data-lucide="kanban" style="width:18px;height:18px"></i> Pipeline
      </a>
    </div>
  </div>
</section>

<!-- Quick Stats -->
<section class="section">
  <div class="grid grid-4" id="dashStats">
    <div class="kpi-card"><div class="kpi-value" id="dsTotalIdeas">--</div><div class="kpi-label">Total Ideas</div></div>
    <div class="kpi-card"><div class="kpi-value" id="dsPendingReview">--</div><div class="kpi-label">Pending Review</div></div>
    <div class="kpi-card"><div class="kpi-value" id="dsLikelyWins">--</div><div class="kpi-label">Likely Wins</div></div>
    <div class="kpi-card"><div class="kpi-value" id="dsDeployed">--</div><div class="kpi-label">Deployed</div></div>
  </div>
</section>

<!-- View Toggle -->
<section class="section">
  <div class="flex justify-between items-center mb-lg">
    <div class="tabs" style="border:none;margin:0">
      <button class="tab-btn active" data-view="matrix">Priority Matrix</button>
      <button class="tab-btn" data-view="list">List View</button>
    </div>
    <div class="filter-bar" style="margin:0">
      <input type="text" id="ideaSearch" class="form-control search-input" placeholder="Search ideas..." style="max-width:280px" />
      <select id="filterStatus" class="form-control" style="width:auto;min-width:160px">
        <option value="">All Statuses</option>
      </select>
      <select id="filterFunction" class="form-control" style="width:auto;min-width:160px">
        <option value="">All Functions</option>
      </select>
    </div>
  </div>

  <!-- Matrix View -->
  <div id="matrixView">
    <div class="priority-matrix" id="priorityMatrix">
      <div class="matrix-quadrant q-likely-wins" data-quadrant="likely_wins">
        <h4 style="color:#28A745">Likely Wins</h4>
        <p class="text-xs text-muted">High Value &amp; High Feasibility</p>
        <div class="matrix-items" id="qLikelyWins"></div>
      </div>
      <div class="matrix-quadrant q-calculated-risks" data-quadrant="calculated_risks">
        <h4 style="color:#9A7B00">Calculated Risks</h4>
        <p class="text-xs text-muted">High Value &amp; Low Feasibility</p>
        <div class="matrix-items" id="qCalculatedRisks"></div>
      </div>
      <div class="matrix-quadrant q-marginal-gains" data-quadrant="marginal_gains">
        <h4 style="color:#6C757D">Marginal Gains</h4>
        <p class="text-xs text-muted">Low Value &amp; High Feasibility</p>
        <div class="matrix-items" id="qMarginalGains"></div>
      </div>
      <div class="matrix-quadrant q-avoid" data-quadrant="avoid">
        <h4 style="color:#DC3545">Avoid</h4>
        <p class="text-xs text-muted">Low Value &amp; Low Feasibility</p>
        <div class="matrix-items" id="qAvoid"></div>
      </div>
    </div>
  </div>

  <!-- List View (hidden by default) -->
  <div id="listView" style="display:none">
    <div class="grid grid-2" id="ideasList">
      <div class="empty-state" style="grid-column:1/-1"><p>Loading ideas&hellip;</p></div>
    </div>
  </div>
</section>

<!-- Quadrant Summary -->
<section class="section" id="quadrantSummary">
  <h2 class="section-title">Quadrant Summary</h2>
  <div class="grid grid-4" id="quadrantCards"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  var allIdeas = [];

  try {
    allIdeas = await AppApi.getIdeas();
    allIdeas = await AppApi.enrichIdeasWithAssessments(allIdeas);
  } catch (err) {
    console.error('Failed to load ideas:', err);
    return;
  }

  // Populate filter dropdowns
  var statusSelect = document.getElementById('filterStatus');
  AppData.IDEA_STATUSES.forEach(function (s) {
    var opt = document.createElement('option');
    opt.value = s.value;
    opt.textContent = s.label;
    statusSelect.appendChild(opt);
  });
  var funcSelect = document.getElementById('filterFunction');
  AppData.BUSINESS_FUNCTIONS.forEach(function (f) {
    var opt = document.createElement('option');
    opt.value = f;
    opt.textContent = f;
    funcSelect.appendChild(opt);
  });

  // Stats
  document.getElementById('dsTotalIdeas').textContent = allIdeas.length;
  document.getElementById('dsPendingReview').textContent =
    allIdeas.filter(function (i) { return i.cr7b4_Status === 100000000 || i.cr7b4_Status === 100000001; }).length;
  document.getElementById('dsLikelyWins').textContent =
    allIdeas.filter(function (i) { return i._assessment && i._assessment.cr7b4_Quadrant === 100000000; }).length;
  document.getElementById('dsDeployed').textContent =
    allIdeas.filter(function (i) { return i.cr7b4_Status === 100000006; }).length;

  // Render functions
  function renderMatrix (ideas) {
    var assessed = ideas.filter(function (i) { return i._assessment; });
    var quadrants = { 100000000: [], 100000001: [], 100000002: [], 100000003: [] };
    assessed.forEach(function (idea) {
      var q = idea._assessment.cr7b4_Quadrant;
      if (quadrants[q]) quadrants[q].push(idea);
    });

    document.getElementById('qLikelyWins').innerHTML =
      quadrants[100000000].map(function (i) { return '<a class="matrix-dot" href="/ideas/detail?id=' + i.cr7b4_AI_Ideaid + '">' + i.cr7b4_Title + '</a>'; }).join('') || '<span class="text-xs text-muted">None</span>';
    document.getElementById('qCalculatedRisks').innerHTML =
      quadrants[100000001].map(function (i) { return '<a class="matrix-dot" href="/ideas/detail?id=' + i.cr7b4_AI_Ideaid + '">' + i.cr7b4_Title + '</a>'; }).join('') || '<span class="text-xs text-muted">None</span>';
    document.getElementById('qMarginalGains').innerHTML =
      quadrants[100000002].map(function (i) { return '<a class="matrix-dot" href="/ideas/detail?id=' + i.cr7b4_AI_Ideaid + '">' + i.cr7b4_Title + '</a>'; }).join('') || '<span class="text-xs text-muted">None</span>';
    document.getElementById('qAvoid').innerHTML =
      quadrants[100000003].map(function (i) { return '<a class="matrix-dot" href="/ideas/detail?id=' + i.cr7b4_AI_Ideaid + '">' + i.cr7b4_Title + '</a>'; }).join('') || '<span class="text-xs text-muted">None</span>';

    // Quadrant summary cards
    var cardData = [
      { label: 'Likely Wins', count: quadrants[100000000].length, color: '#28A745', desc: 'Prioritize these' },
      { label: 'Calculated Risks', count: quadrants[100000001].length, color: '#FFC107', desc: 'Strategic bets' },
      { label: 'Marginal Gains', count: quadrants[100000002].length, color: '#6C757D', desc: 'Selective pursuit' },
      { label: 'Avoid', count: quadrants[100000003].length, color: '#DC3545', desc: 'Deprioritize' }
    ];
    document.getElementById('quadrantCards').innerHTML = cardData.map(function (c) {
      return '<div class="kpi-card"><div class="kpi-value" style="color:' + c.color + '">' + c.count + '</div><div class="kpi-label">' + c.label + '</div><div class="text-xs text-muted">' + c.desc + '</div></div>';
    }).join('');
  }

  function renderList (ideas) {
    var container = document.getElementById('ideasList');
    if (ideas.length === 0) {
      container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>No ideas match your filters.</p></div>';
      return;
    }
    container.innerHTML = ideas.map(function (idea) {
      return AppUI.renderIdeaCard(idea);
    }).join('');
    lucide.createIcons();
  }

  function applyFilters () {
    var query = (document.getElementById('ideaSearch').value || '').toLowerCase();
    var status = document.getElementById('filterStatus').value;
    var func = document.getElementById('filterFunction').value;
    var filtered = allIdeas.filter(function (i) {
      if (query && i.cr7b4_Title.toLowerCase().indexOf(query) === -1 && i.cr7b4_Description.toLowerCase().indexOf(query) === -1) return false;
      if (status && String(i.cr7b4_Status) !== status) return false;
      if (func && AppData.getChoiceLabel('BusinessFunction', i.cr7b4_BusinessFunction) !== func) return false;
      return true;
    });
    renderMatrix(filtered);
    renderList(filtered);
  }

  // Initial render
  applyFilters();

  // Event listeners
  document.getElementById('ideaSearch').addEventListener('input', applyFilters);
  document.getElementById('filterStatus').addEventListener('change', applyFilters);
  document.getElementById('filterFunction').addEventListener('change', applyFilters);

  // View toggle
  document.querySelectorAll('.tab-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      document.querySelectorAll('.tab-btn').forEach(function (b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var view = btn.getAttribute('data-view');
      document.getElementById('matrixView').style.display = view === 'matrix' ? '' : 'none';
      document.getElementById('listView').style.display = view === 'list' ? '' : 'none';
    });
  });
});
</script>
{% endblock %}
