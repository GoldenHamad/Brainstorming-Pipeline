{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Pipeline â€” Kanban Board
  ============================================================
{% endcomment %}

<section class="hero">
  <div class="flex justify-between items-center flex-wrap gap-md">
    <div>
      <h1>Innovation Pipeline</h1>
      <p>Track AI use cases from ideation through scaling.</p>
    </div>
    <div class="flex gap-sm">
      <a href="/ideas/submit" class="btn btn-lg" style="background:#fff;color:var(--color-primary)">
        <i data-lucide="plus" style="width:18px;height:18px"></i> Submit Idea
      </a>
      <a href="/ideas" class="btn btn-lg btn-ghost">
        <i data-lucide="layout-grid" style="width:18px;height:18px"></i> Dashboard
      </a>
    </div>
  </div>
</section>

<!-- Pipeline Stats -->
<section class="section">
  <div class="grid grid-4" id="pipelineStats">
    <div class="kpi-card"><div class="kpi-value" id="psTotalActive">--</div><div class="kpi-label">Active Ideas</div></div>
    <div class="kpi-card"><div class="kpi-value" id="psInProgress">--</div><div class="kpi-label">In Progress</div></div>
    <div class="kpi-card"><div class="kpi-value" id="psDeployed">--</div><div class="kpi-label">Deployed</div></div>
    <div class="kpi-card"><div class="kpi-value" id="psOnHold">--</div><div class="kpi-label">On Hold</div></div>
  </div>
</section>

<!-- Kanban Board -->
<section class="section">
  <h2 class="section-title">Pipeline Board</h2>
  <div class="pipeline-board" id="pipelineBoard">
    <!-- Columns rendered by JS -->
  </div>
</section>

<!-- On Hold / Rejected -->
<section class="section">
  <div class="grid grid-2">
    <div>
      <h3 class="section-title">On Hold</h3>
      <div id="onHoldList" class="flex flex-col gap-sm"></div>
    </div>
    <div>
      <h3 class="section-title">Rejected</h3>
      <div id="rejectedList" class="flex flex-col gap-sm"></div>
    </div>
  </div>
</section>

<!-- Status Update Modal -->
<div class="modal-overlay" id="statusModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Update Status</h3>
      <button class="modal-close" id="closeStatusModal">&times;</button>
    </div>
    <div class="form-group">
      <label class="form-label">New Status</label>
      <select class="form-control" id="modalNewStatus"></select>
    </div>
    <div class="flex justify-between mt-lg">
      <button class="btn btn-secondary" id="cancelStatusModal">Cancel</button>
      <button class="btn btn-primary" id="confirmStatusChange">Update</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  var allIdeas = [];

  // Pipeline stages (main columns)
  var pipelineStages = [
    { value: 100000000, label: 'Submitted', color: '#6C757D' },
    { value: 100000001, label: 'Screening', color: '#17A2B8' },
    { value: 100000002, label: 'Assessment', color: '#483698' },
    { value: 100000003, label: 'Prioritized', color: '#00A3A1' },
    { value: 100000004, label: 'Development', color: '#FFC107' },
    { value: 100000005, label: 'Pilot', color: '#FF6B35' },
    { value: 100000006, label: 'Deployed', color: '#28A745' },
    { value: 100000007, label: 'Scaling', color: '#00338D' }
  ];

  try {
    allIdeas = await AppApi.getIdeas();
  } catch (err) {
    console.error('Failed to load ideas:', err);
    return;
  }

  // Stats
  var activeStatuses = [100000000,100000001,100000002,100000003,100000004,100000005,100000006,100000007];
  document.getElementById('psTotalActive').textContent =
    allIdeas.filter(function (i) { return activeStatuses.indexOf(i.cr7b4_Status) >= 0; }).length;
  document.getElementById('psInProgress').textContent =
    allIdeas.filter(function (i) { return i.cr7b4_Status === 100000004 || i.cr7b4_Status === 100000005; }).length;
  document.getElementById('psDeployed').textContent =
    allIdeas.filter(function (i) { return i.cr7b4_Status === 100000006 || i.cr7b4_Status === 100000007; }).length;
  document.getElementById('psOnHold').textContent =
    allIdeas.filter(function (i) { return i.cr7b4_Status === 100000008; }).length;

  // Build Kanban columns
  var board = document.getElementById('pipelineBoard');
  board.innerHTML = '';

  pipelineStages.forEach(function (stage) {
    var stageIdeas = allIdeas.filter(function (i) { return i.cr7b4_Status === stage.value; });
    var col = document.createElement('div');
    col.className = 'pipeline-column';
    col.innerHTML = '<div class="pipeline-column-header">' +
      '<span style="color:' + stage.color + '">' + stage.label + '</span>' +
      '<span class="count">' + stageIdeas.length + '</span></div>';

    var cardsHtml = stageIdeas.map(function (idea) {
      var capLabel = AppData.getChoiceLabel('AICapabilityArea', idea.cr7b4_AICapabilityArea);
      return '<div class="pipeline-card" data-idea-id="' + idea.cr7b4_AI_Ideaid + '" onclick="openIdeaDetail(\'' + idea.cr7b4_AI_Ideaid + '\')">' +
        '<div class="card-title">' + AppUI.escapeHtml(idea.cr7b4_Title) + '</div>' +
        '<div class="card-meta">' + capLabel + '</div>' +
        '<div class="flex gap-xs mt-sm">' +
        (stage.value < 100000007 ? '<button class="btn btn-success btn-sm" onclick="event.stopPropagation();advanceIdea(\'' + idea.cr7b4_AI_Ideaid + '\',' + stage.value + ')" title="Advance">&#x2192;</button>' : '') +
        '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();openStatusModal(\'' + idea.cr7b4_AI_Ideaid + '\')" title="Change status">&#x22EF;</button>' +
        '</div></div>';
    }).join('');

    if (stageIdeas.length === 0) {
      cardsHtml = '<div class="text-xs text-muted text-center" style="padding:1rem">No ideas</div>';
    }
    col.innerHTML += cardsHtml;
    board.appendChild(col);
  });

  // On Hold / Rejected
  var onHold = allIdeas.filter(function (i) { return i.cr7b4_Status === 100000008; });
  var rejected = allIdeas.filter(function (i) { return i.cr7b4_Status === 100000009; });

  document.getElementById('onHoldList').innerHTML = onHold.length
    ? onHold.map(function (i) { return '<div class="pipeline-card"><div class="card-title">' + AppUI.escapeHtml(i.cr7b4_Title) + '</div></div>'; }).join('')
    : '<div class="text-sm text-muted">No ideas on hold.</div>';

  document.getElementById('rejectedList').innerHTML = rejected.length
    ? rejected.map(function (i) { return '<div class="pipeline-card"><div class="card-title">' + AppUI.escapeHtml(i.cr7b4_Title) + '</div></div>'; }).join('')
    : '<div class="text-sm text-muted">No rejected ideas.</div>';

  lucide.createIcons();

  // --- Modal logic ---
  var selectedIdeaId = null;

  window.openIdeaDetail = function (id) {
    window.location.href = '/ideas/detail?id=' + id;
  };

  window.advanceIdea = async function (id, currentStatus) {
    try {
      await AppApi.updateIdea(id, { cr7b4_Status: currentStatus + 1 });
      AppUI.showToast('Idea advanced!', 'success');
      setTimeout(function () { location.reload(); }, 500);
    } catch (err) {
      AppUI.showToast('Failed to update status.', 'error');
    }
  };

  window.openStatusModal = function (id) {
    selectedIdeaId = id;
    var select = document.getElementById('modalNewStatus');
    select.innerHTML = '';
    AppData.IDEA_STATUSES.forEach(function (s) {
      var opt = document.createElement('option');
      opt.value = s.value;
      opt.textContent = s.label;
      select.appendChild(opt);
    });
    document.getElementById('statusModal').classList.add('open');
  };

  document.getElementById('closeStatusModal').addEventListener('click', function () {
    document.getElementById('statusModal').classList.remove('open');
  });
  document.getElementById('cancelStatusModal').addEventListener('click', function () {
    document.getElementById('statusModal').classList.remove('open');
  });
  document.getElementById('confirmStatusChange').addEventListener('click', async function () {
    var newStatus = parseInt(document.getElementById('modalNewStatus').value);
    try {
      await AppApi.updateIdea(selectedIdeaId, { cr7b4_Status: newStatus });
      document.getElementById('statusModal').classList.remove('open');
      AppUI.showToast('Status updated!', 'success');
      setTimeout(function () { location.reload(); }, 500);
    } catch (err) {
      AppUI.showToast('Failed to update status.', 'error');
    }
  });
});
</script>
{% endblock %}
