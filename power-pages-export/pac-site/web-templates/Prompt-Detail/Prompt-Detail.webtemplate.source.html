{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Prompt Detail — View, Copy, Rate
  ============================================================
{% endcomment %}

<div id="promptDetailContainer">
  <div class="empty-state"><p>Loading prompt&hellip;</p></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  var params = new URLSearchParams(window.location.search);
  var promptId = params.get('id');
  var container = document.getElementById('promptDetailContainer');

  if (!promptId) {
    container.innerHTML = '<div class="empty-state"><p>No prompt specified. <a href="/prompts">Back to Library</a></p></div>';
    return;
  }

  try {
    var prompt = await AppApi.getPromptById(promptId);
    if (!prompt) {
      container.innerHTML = '<div class="empty-state"><p>Prompt not found. <a href="/prompts">Back to Library</a></p></div>';
      return;
    }

    var catLabel = AppData.getChoiceLabel('PromptCategory', prompt.cr7b4_Category);
    var complexLabel = AppData.getChoiceLabel('ComplexityLevel', prompt.cr7b4_ComplexityLevel);
    var formatLabel = AppData.getChoiceLabel('OutputFormat', prompt.cr7b4_OutputFormat);
    var tags = (prompt.cr7b4_Tags || '').split(';').filter(Boolean);

    var html = '';

    // Breadcrumb
    html += '<nav class="flex items-center gap-sm mb-lg text-sm text-muted">';
    html += '<a href="/prompts">Prompt Library</a><span>/</span>';
    html += '<span>' + AppUI.escapeHtml(prompt.cr7b4_Title) + '</span></nav>';

    // Two-column layout
    html += '<div style="display:grid;grid-template-columns:1fr 320px;gap:var(--space-xl)">';

    // Main content
    html += '<div>';
    // Header
    html += '<div class="flex gap-sm items-center mb-sm">';
    html += '<span class="badge" style="background:var(--color-primary);color:#fff">' + catLabel + '</span>';
    html += '<span class="badge badge-' + complexLabel.toLowerCase() + '">' + complexLabel + '</span>';
    if (prompt.cr7b4_Version) html += '<span class="text-xs text-muted">v' + prompt.cr7b4_Version + '</span>';
    html += '</div>';
    html += '<h1 style="font-size:var(--font-size-2xl);margin-bottom:var(--space-lg)">' + AppUI.escapeHtml(prompt.cr7b4_Title) + '</h1>';

    // Prompt text
    html += '<div class="card mb-lg"><div class="card-body">';
    html += '<div class="flex justify-between items-center mb-md">';
    html += '<h3 style="font-size:var(--font-size-base)">Prompt Text</h3>';
    html += '<button class="btn btn-primary btn-sm" id="copyBtn" onclick="copyPrompt()"><i data-lucide="copy" style="width:14px;height:14px"></i> Copy</button>';
    html += '</div>';
    html += '<pre style="white-space:pre-wrap;font-size:var(--font-size-sm);background:var(--color-bg);padding:var(--space-lg);border-radius:var(--radius-md);line-height:1.7" id="promptText">' + AppUI.escapeHtml(prompt.cr7b4_PromptText) + '</pre>';
    html += '</div></div>';

    // Best practices
    if (prompt.cr7b4_BestPractices) {
      html += '<div class="card mb-lg"><div class="card-body">';
      html += '<h3 style="font-size:var(--font-size-base);margin-bottom:var(--space-sm)">Best Practices</h3>';
      html += '<p class="text-sm">' + AppUI.escapeHtml(prompt.cr7b4_BestPractices) + '</p>';
      html += '</div></div>';
    }

    // Rating section
    html += '<div class="card mb-lg"><div class="card-body">';
    html += '<h3 style="font-size:var(--font-size-base);margin-bottom:var(--space-md)">Rate This Prompt</h3>';
    html += '<div class="flex items-center gap-lg">';
    html += '<div class="star-rating" id="starRating">';
    for (var i = 1; i <= 5; i++) {
      html += '<span class="star" data-value="' + i + '" style="font-size:1.5rem;cursor:pointer">&#9733;</span>';
    }
    html += '</div>';
    html += '<button class="btn btn-primary btn-sm" id="rateBtn" disabled>Submit Rating</button>';
    html += '</div>';
    html += '<div class="text-xs text-muted mt-sm">Current: ' + AppUI.renderStars(prompt.cr7b4_Rating || 0) + ' ' + (prompt.cr7b4_Rating || 0).toFixed(1) + ' (' + (prompt.cr7b4_RatingCount || 0) + ' ratings)</div>';
    html += '</div></div>';

    html += '</div>'; // end main

    // Sidebar
    html += '<div>';
    html += '<div class="card mb-lg"><div class="card-body">';
    html += '<h3 style="font-size:var(--font-size-sm);margin-bottom:var(--space-md)">Details</h3>';
    html += '<div class="mb-md"><label class="form-label">Output Format</label><p class="text-sm">' + formatLabel + '</p></div>';
    html += '<div class="mb-md"><label class="form-label">Owner</label><p class="text-sm">' + AppUI.escapeHtml(prompt.cr7b4_OwnerName || '—') + '</p></div>';
    html += '<div class="mb-md"><label class="form-label">Usage</label><p class="text-sm">' + (prompt.cr7b4_UsageCount || 0).toLocaleString() + ' copies</p></div>';
    html += '<div class="mb-md"><label class="form-label">Rating</label><p class="text-sm">' + (prompt.cr7b4_Rating || 0).toFixed(1) + ' / 5.0</p></div>';
    html += '</div></div>';

    // Tags
    if (tags.length) {
      html += '<div class="card"><div class="card-body">';
      html += '<h3 style="font-size:var(--font-size-sm);margin-bottom:var(--space-sm)">Tags</h3>';
      html += '<div class="flex flex-wrap gap-xs">';
      tags.forEach(function (t) {
        html += '<span class="badge" style="background:var(--color-bg-alt);color:var(--color-text-secondary)">' + t.trim() + '</span>';
      });
      html += '</div></div></div>';
    }
    html += '</div>'; // end sidebar

    html += '</div>'; // end grid

    container.innerHTML = html;
    lucide.createIcons();

    // Star rating interaction
    var selectedRating = 0;
    document.querySelectorAll('#starRating .star').forEach(function (star) {
      star.addEventListener('click', function () {
        selectedRating = parseInt(this.getAttribute('data-value'));
        document.querySelectorAll('#starRating .star').forEach(function (s) {
          s.classList.toggle('filled', parseInt(s.getAttribute('data-value')) <= selectedRating);
        });
        document.getElementById('rateBtn').disabled = false;
      });
      star.addEventListener('mouseenter', function () {
        var hoverVal = parseInt(this.getAttribute('data-value'));
        document.querySelectorAll('#starRating .star').forEach(function (s) {
          s.style.color = parseInt(s.getAttribute('data-value')) <= hoverVal ? '#FFD54F' : '';
        });
      });
      star.addEventListener('mouseleave', function () {
        document.querySelectorAll('#starRating .star').forEach(function (s) {
          s.style.color = s.classList.contains('filled') ? '#FFC107' : '';
        });
      });
    });

    // Submit rating
    document.getElementById('rateBtn').addEventListener('click', async function () {
      if (!selectedRating) return;
      this.disabled = true;
      this.textContent = 'Saving...';
      try {
        await AppApi.createRating({
          'cr7b4_PromptId@odata.bind': '/cr7b4_ai_prompts(' + promptId + ')',
          cr7b4_Rating: selectedRating,
          cr7b4_RatedBy: '{{ user.fullname | default: "Anonymous" }}'
        });
        // Update average on the prompt
        var newCount = (prompt.cr7b4_RatingCount || 0) + 1;
        var newAvg = ((prompt.cr7b4_Rating || 0) * (prompt.cr7b4_RatingCount || 0) + selectedRating) / newCount;
        await AppApi.updatePrompt(promptId, { cr7b4_Rating: Math.round(newAvg * 10) / 10, cr7b4_RatingCount: newCount });
        AppUI.showToast('Rating submitted. Thank you!', 'success');
        setTimeout(function () { location.reload(); }, 800);
      } catch (err) {
        AppUI.showToast('Failed to submit rating.', 'error');
        this.disabled = false;
        this.textContent = 'Submit Rating';
      }
    });

    // Copy prompt
    window.copyPrompt = async function () {
      try {
        await navigator.clipboard.writeText(prompt.cr7b4_PromptText);
        var btn = document.getElementById('copyBtn');
        btn.innerHTML = '<i data-lucide="check" style="width:14px;height:14px"></i> Copied!';
        lucide.createIcons();
        // Increment usage count
        await AppApi.updatePrompt(promptId, { cr7b4_UsageCount: (prompt.cr7b4_UsageCount || 0) + 1 });
        setTimeout(function () {
          btn.innerHTML = '<i data-lucide="copy" style="width:14px;height:14px"></i> Copy';
          lucide.createIcons();
        }, 2000);
      } catch (err) {
        AppUI.showToast('Failed to copy.', 'error');
      }
    };

  } catch (err) {
    console.error('Prompt detail error:', err);
    container.innerHTML = '<div class="empty-state"><p>Error loading prompt. <a href="/prompts">Back to Library</a></p></div>';
  }
});
</script>
{% endblock %}
