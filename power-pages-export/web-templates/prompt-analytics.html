{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Prompt Analytics â€” Usage KPIs & Charts
  ============================================================
{% endcomment %}

<section class="hero">
  <h1>Prompt Analytics</h1>
  <p>Usage metrics and insights across the AI prompt library.</p>
</section>

<!-- KPI Cards -->
<section class="section">
  <div class="grid grid-4">
    <div class="kpi-card"><div class="kpi-value" id="paTotalPrompts">--</div><div class="kpi-label">Total Prompts</div></div>
    <div class="kpi-card"><div class="kpi-value" id="paTotalCopies">--</div><div class="kpi-label">Total Copies</div></div>
    <div class="kpi-card"><div class="kpi-value" id="paAvgRating">--</div><div class="kpi-label">Average Rating</div></div>
    <div class="kpi-card"><div class="kpi-value" id="paTotalRatings">--</div><div class="kpi-label">Total Ratings</div></div>
  </div>
</section>

<!-- Charts -->
<section class="section">
  <div class="grid grid-2">
    <!-- By Category -->
    <div class="card">
      <div class="card-header">Prompts by Category</div>
      <div class="card-body">
        <canvas id="chartPromptCategory" height="260"></canvas>
      </div>
    </div>
    <!-- By Complexity -->
    <div class="card">
      <div class="card-header">Prompts by Complexity</div>
      <div class="card-body">
        <canvas id="chartPromptComplexity" height="260"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Top Prompts -->
<section class="section">
  <div class="card">
    <div class="card-header">Top 10 Most Used Prompts</div>
    <div class="card-body">
      <table class="data-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Title</th>
            <th>Category</th>
            <th>Copies</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody id="topPromptsBody">
          <tr><td colspan="5" class="text-center text-muted">Loading&hellip;</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  try {
    var prompts = await AppApi.getPrompts({ status: 'Approved' });

    // KPIs
    var totalCopies = prompts.reduce(function (s, p) { return s + (p.cr7b4_UsageCount || 0); }, 0);
    var totalRatings = prompts.reduce(function (s, p) { return s + (p.cr7b4_RatingCount || 0); }, 0);
    var avgRating = prompts.length
      ? (prompts.reduce(function (s, p) { return s + (p.cr7b4_Rating || 0); }, 0) / prompts.length)
      : 0;

    document.getElementById('paTotalPrompts').textContent = prompts.length;
    document.getElementById('paTotalCopies').textContent = totalCopies.toLocaleString();
    document.getElementById('paAvgRating').textContent = avgRating.toFixed(1);
    document.getElementById('paTotalRatings').textContent = totalRatings.toLocaleString();

    // Category chart
    var catCounts = {};
    var categoryColors = ['#00338D', '#28A745', '#483698', '#00A3A1', '#FF6B35', '#17A2B8'];
    prompts.forEach(function (p) {
      var label = AppData.getChoiceLabel('PromptCategory', p.cr7b4_Category);
      catCounts[label] = (catCounts[label] || 0) + 1;
    });
    new Chart(document.getElementById('chartPromptCategory'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(catCounts),
        datasets: [{ data: Object.values(catCounts), backgroundColor: categoryColors.slice(0, Object.keys(catCounts).length) }]
      },
      options: { responsive: true }
    });

    // Complexity chart
    var complexCounts = { 'Beginner': 0, 'Intermediate': 0, 'Expert': 0 };
    prompts.forEach(function (p) {
      var label = AppData.getChoiceLabel('ComplexityLevel', p.cr7b4_ComplexityLevel);
      complexCounts[label] = (complexCounts[label] || 0) + 1;
    });
    new Chart(document.getElementById('chartPromptComplexity'), {
      type: 'bar',
      data: {
        labels: Object.keys(complexCounts),
        datasets: [{ label: 'Prompts', data: Object.values(complexCounts),
          backgroundColor: ['#28A745', '#FFC107', '#DC3545'], borderRadius: 6 }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });

    // Top prompts table
    var sorted = prompts.slice().sort(function (a, b) {
      return (b.cr7b4_UsageCount || 0) - (a.cr7b4_UsageCount || 0);
    }).slice(0, 10);
    document.getElementById('topPromptsBody').innerHTML = sorted.map(function (p, idx) {
      var catLabel = AppData.getChoiceLabel('PromptCategory', p.cr7b4_Category);
      return '<tr>' +
        '<td><strong>' + (idx + 1) + '</strong></td>' +
        '<td><a href="/prompts/detail?id=' + p.cr7b4_AI_Promptid + '">' + AppUI.escapeHtml(p.cr7b4_Title) + '</a></td>' +
        '<td>' + catLabel + '</td>' +
        '<td>' + (p.cr7b4_UsageCount || 0).toLocaleString() + '</td>' +
        '<td>' + AppUI.renderStars(p.cr7b4_Rating || 0) + ' ' + (p.cr7b4_Rating || 0).toFixed(1) + '</td>' +
        '</tr>';
    }).join('');

  } catch (err) {
    console.error('Prompt analytics error:', err);
  }
});
</script>
{% endblock %}
