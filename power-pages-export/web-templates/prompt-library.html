{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Prompt Library â€” Browse, Search, Filter
  ============================================================
{% endcomment %}

<section class="hero">
  <div class="flex justify-between items-center flex-wrap gap-md">
    <div>
      <h1>AI Prompt Library</h1>
      <p>Curated prompts for client deliverables, productivity, research, and more.</p>
    </div>
    <a href="/prompts/submit" class="btn btn-lg" style="background:#fff;color:var(--color-primary)">
      <i data-lucide="plus" style="width:18px;height:18px"></i> Submit Prompt
    </a>
  </div>
</section>

<!-- Search & Filters -->
<section class="section">
  <div class="filter-bar">
    <input type="text" id="promptSearch" class="form-control search-input" placeholder="Search prompts by title, text, or tags..." />
    <select id="filterCategory" class="form-control" style="width:auto;min-width:180px">
      <option value="">All Categories</option>
    </select>
    <select id="filterComplexity" class="form-control" style="width:auto;min-width:160px">
      <option value="">All Levels</option>
      <option value="100000000">Beginner</option>
      <option value="100000001">Intermediate</option>
      <option value="100000002">Expert</option>
    </select>
  </div>
</section>

<!-- Category Cards -->
<section class="section" id="categorySection">
  <h2 class="section-title">Browse by Category</h2>
  <div class="grid grid-3" id="categoryCards"></div>
</section>

<!-- Prompts Grid -->
<section class="section">
  <div class="flex justify-between items-center mb-lg">
    <h2 class="section-title" style="margin-bottom:0">
      All Prompts <span class="text-muted text-sm" id="promptCount"></span>
    </h2>
  </div>
  <div class="grid grid-3" id="promptsGrid">
    <div class="empty-state" style="grid-column:1/-1"><p>Loading prompts&hellip;</p></div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  var allPrompts = [];

  var categoryColors = {
    'Client Deliverables': '#00338D',
    'Internal Productivity': '#28A745',
    'Research & Analysis': '#483698',
    'Data & Finance': '#00A3A1',
    'Creative & Marketing': '#FF6B35',
    'Technical': '#17A2B8'
  };

  try {
    allPrompts = await AppApi.getPrompts({ status: 'Approved' });
  } catch (err) {
    console.error('Failed to load prompts:', err);
    return;
  }

  // Populate category filter
  var catSelect = document.getElementById('filterCategory');
  AppData.PROMPT_CATEGORIES.forEach(function (c, idx) {
    var opt = document.createElement('option');
    opt.value = 100000000 + idx;
    opt.textContent = c;
    catSelect.appendChild(opt);
  });

  // Category cards
  var catCounts = {};
  allPrompts.forEach(function (p) {
    var label = AppData.getChoiceLabel('PromptCategory', p.cr7b4_Category);
    catCounts[label] = (catCounts[label] || 0) + 1;
  });
  document.getElementById('categoryCards').innerHTML = Object.entries(catCounts).map(function (entry) {
    var name = entry[0], count = entry[1];
    var color = categoryColors[name] || '#6C757D';
    return '<div class="card" style="cursor:pointer;border-left:4px solid ' + color + '" onclick="filterByCategory(\'' + name + '\')">' +
      '<div class="card-body flex justify-between items-center">' +
      '<div><h3 style="font-size:var(--font-size-base);margin-bottom:2px">' + name + '</h3>' +
      '<span class="text-sm text-muted">' + count + ' prompt' + (count !== 1 ? 's' : '') + '</span></div>' +
      '<span style="font-size:1.5rem;color:' + color + '">' + count + '</span>' +
      '</div></div>';
  }).join('');

  // Render prompts
  function renderPrompts (prompts) {
    var grid = document.getElementById('promptsGrid');
    document.getElementById('promptCount').textContent = '(' + prompts.length + ')';
    if (prompts.length === 0) {
      grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>No prompts match your filters.</p></div>';
      return;
    }
    grid.innerHTML = prompts.map(function (p) {
      var catLabel = AppData.getChoiceLabel('PromptCategory', p.cr7b4_Category);
      var complexLabel = AppData.getChoiceLabel('ComplexityLevel', p.cr7b4_ComplexityLevel);
      var complexKey = complexLabel.toLowerCase();
      var color = categoryColors[catLabel] || '#6C757D';
      return '<div class="prompt-card" style="border-top:3px solid ' + color + '">' +
        '<div class="flex justify-between items-center mb-sm">' +
        '<span class="badge" style="background:' + color + '20;color:' + color + '">' + catLabel + '</span>' +
        '<span class="badge badge-' + complexKey + '">' + complexLabel + '</span>' +
        '</div>' +
        '<a href="/prompts/detail?id=' + p.cr7b4_AI_Promptid + '" class="prompt-title" style="display:block;color:var(--color-text)">' + AppUI.escapeHtml(p.cr7b4_Title) + '</a>' +
        '<p class="prompt-excerpt">' + AppUI.escapeHtml(p.cr7b4_PromptText) + '</p>' +
        '<div class="prompt-footer">' +
        '<span>' + AppUI.renderStars(p.cr7b4_Rating || 0) + ' ' + (p.cr7b4_Rating || 0).toFixed(1) + '</span>' +
        '<span>' + (p.cr7b4_UsageCount || 0).toLocaleString() + ' copies</span>' +
        '</div></div>';
    }).join('');
    lucide.createIcons();
  }

  function applyFilters () {
    var query = (document.getElementById('promptSearch').value || '').toLowerCase();
    var cat = document.getElementById('filterCategory').value;
    var complexity = document.getElementById('filterComplexity').value;
    var filtered = allPrompts.filter(function (p) {
      if (query) {
        var match = (p.cr7b4_Title || '').toLowerCase().indexOf(query) >= 0
          || (p.cr7b4_PromptText || '').toLowerCase().indexOf(query) >= 0
          || (p.cr7b4_Tags || '').toLowerCase().indexOf(query) >= 0;
        if (!match) return false;
      }
      if (cat && String(p.cr7b4_Category) !== cat) return false;
      if (complexity && String(p.cr7b4_ComplexityLevel) !== complexity) return false;
      return true;
    });
    renderPrompts(filtered);
  }

  // Initial render
  applyFilters();

  // Event listeners
  document.getElementById('promptSearch').addEventListener('input', applyFilters);
  document.getElementById('filterCategory').addEventListener('change', applyFilters);
  document.getElementById('filterComplexity').addEventListener('change', applyFilters);

  // Category card click
  window.filterByCategory = function (name) {
    var idx = AppData.PROMPT_CATEGORIES.indexOf(name);
    if (idx >= 0) {
      document.getElementById('filterCategory').value = 100000000 + idx;
      applyFilters();
      document.getElementById('promptsGrid').scrollIntoView({ behavior: 'smooth' });
    }
  };
});
</script>
{% endblock %}
