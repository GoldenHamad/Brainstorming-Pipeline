{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Review Queue — Admin Prompt Approval
  ============================================================
{% endcomment %}

<section class="hero">
  <h1>Prompt Review Queue</h1>
  <p>Review and approve submitted prompts before they appear in the library.</p>
</section>

<!-- Stats -->
<section class="section">
  <div class="grid grid-3">
    <div class="kpi-card"><div class="kpi-value" id="rqPending">--</div><div class="kpi-label">Pending</div></div>
    <div class="kpi-card"><div class="kpi-value text-success" id="rqApproved">--</div><div class="kpi-label">Approved (Today)</div></div>
    <div class="kpi-card"><div class="kpi-value text-danger" id="rqRejected">--</div><div class="kpi-label">Rejected (Today)</div></div>
  </div>
</section>

<!-- Two-panel layout -->
<section class="section">
  <div style="display:grid;grid-template-columns:360px 1fr;gap:var(--space-xl);min-height:500px">

    <!-- Submission list -->
    <div class="card" style="overflow-y:auto;max-height:700px">
      <div class="card-header">Pending Submissions</div>
      <div id="pendingList" style="padding:var(--space-sm)">
        <div class="empty-state"><p>Loading&hellip;</p></div>
      </div>
    </div>

    <!-- Detail panel -->
    <div class="card" id="detailPanel">
      <div class="card-body">
        <div class="empty-state" id="noSelection">
          <i data-lucide="file-text" style="width:48px;height:48px;color:var(--color-text-muted)"></i>
          <p class="mt-md">Select a submission from the left to review it.</p>
        </div>
        <div id="submissionDetail" style="display:none"></div>
      </div>
    </div>
  </div>
</section>

<!-- Rejection Modal -->
<div class="modal-overlay" id="rejectModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Reject Submission</h3>
      <button class="modal-close" id="closeRejectModal">&times;</button>
    </div>
    <div class="form-group">
      <label class="form-label">Reason for Rejection</label>
      <textarea class="form-control" id="rejectReason" rows="3" placeholder="Provide feedback for the submitter..."></textarea>
    </div>
    <div class="flex justify-between mt-lg">
      <button class="btn btn-secondary" id="cancelReject">Cancel</button>
      <button class="btn btn-danger" id="confirmReject">Reject</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  var pendingPrompts = [];
  var selectedPrompt = null;

  try {
    var allPrompts = await AppApi.getPrompts({});
    pendingPrompts = allPrompts.filter(function (p) { return p.cr7b4_PromptStatus === 100000001; });

    document.getElementById('rqPending').textContent = pendingPrompts.length;
    document.getElementById('rqApproved').textContent =
      allPrompts.filter(function (p) { return p.cr7b4_PromptStatus === 100000002; }).length;
    document.getElementById('rqRejected').textContent =
      allPrompts.filter(function (p) { return p.cr7b4_PromptStatus === 100000003; }).length;
  } catch (err) {
    console.error('Review queue error:', err);
    return;
  }

  // Render pending list
  var list = document.getElementById('pendingList');
  if (pendingPrompts.length === 0) {
    list.innerHTML = '<div class="empty-state"><p>No pending submissions.</p></div>';
    return;
  }

  list.innerHTML = pendingPrompts.map(function (p) {
    var catLabel = AppData.getChoiceLabel('PromptCategory', p.cr7b4_Category);
    var complexLabel = AppData.getChoiceLabel('ComplexityLevel', p.cr7b4_ComplexityLevel);
    return '<div class="pipeline-card review-item" data-id="' + p.cr7b4_AI_Promptid + '" style="cursor:pointer">' +
      '<div class="card-title">' + AppUI.escapeHtml(p.cr7b4_Title) + '</div>' +
      '<div class="flex gap-xs mt-sm">' +
      '<span class="badge" style="background:var(--color-bg-alt)">' + catLabel + '</span>' +
      '<span class="badge badge-' + complexLabel.toLowerCase() + '">' + complexLabel + '</span>' +
      '</div>' +
      '<div class="card-meta mt-sm">By ' + AppUI.escapeHtml(p.cr7b4_SubmitterName || 'Unknown') + '</div>' +
      '</div>';
  }).join('');

  // Click handler for list items
  document.querySelectorAll('.review-item').forEach(function (item) {
    item.addEventListener('click', function () {
      var id = this.getAttribute('data-id');
      selectedPrompt = pendingPrompts.find(function (p) { return p.cr7b4_AI_Promptid === id; });
      if (!selectedPrompt) return;

      document.querySelectorAll('.review-item').forEach(function (el) { el.style.borderColor = ''; });
      this.style.borderColor = 'var(--color-primary)';

      var catLabel = AppData.getChoiceLabel('PromptCategory', selectedPrompt.cr7b4_Category);
      var complexLabel = AppData.getChoiceLabel('ComplexityLevel', selectedPrompt.cr7b4_ComplexityLevel);
      var formatLabel = AppData.getChoiceLabel('OutputFormat', selectedPrompt.cr7b4_OutputFormat);

      document.getElementById('noSelection').style.display = 'none';
      var detail = document.getElementById('submissionDetail');
      detail.style.display = '';

      detail.innerHTML =
        '<div class="flex justify-between items-center mb-lg">' +
        '<h2 style="font-size:var(--font-size-xl)">' + AppUI.escapeHtml(selectedPrompt.cr7b4_Title) + '</h2>' +
        '<div class="flex gap-sm">' +
        '<button class="btn btn-success" id="approveBtn"><i data-lucide="check" style="width:16px;height:16px"></i> Approve</button>' +
        '<button class="btn btn-danger" id="rejectBtn"><i data-lucide="x" style="width:16px;height:16px"></i> Reject</button>' +
        '</div></div>' +
        '<div class="flex gap-sm mb-lg">' +
        '<span class="badge" style="background:var(--color-primary);color:#fff">' + catLabel + '</span>' +
        '<span class="badge badge-' + complexLabel.toLowerCase() + '">' + complexLabel + '</span>' +
        '<span class="text-sm text-muted">' + formatLabel + '</span>' +
        '</div>' +
        '<h4 class="mb-sm">Prompt Text</h4>' +
        '<pre style="white-space:pre-wrap;background:var(--color-bg);padding:var(--space-lg);border-radius:var(--radius-md);font-size:var(--font-size-sm);margin-bottom:var(--space-lg)">' + AppUI.escapeHtml(selectedPrompt.cr7b4_PromptText) + '</pre>' +
        (selectedPrompt.cr7b4_BestPractices ? '<h4 class="mb-sm">Best Practices</h4><p class="text-sm mb-lg">' + AppUI.escapeHtml(selectedPrompt.cr7b4_BestPractices) + '</p>' : '') +
        '<div class="grid grid-3">' +
        '<div><label class="form-label">Owner</label><p class="text-sm">' + AppUI.escapeHtml(selectedPrompt.cr7b4_OwnerName || '—') + '</p></div>' +
        '<div><label class="form-label">Submitter</label><p class="text-sm">' + AppUI.escapeHtml(selectedPrompt.cr7b4_SubmitterName || '—') + '</p></div>' +
        '<div><label class="form-label">Tags</label><p class="text-sm">' + AppUI.escapeHtml(selectedPrompt.cr7b4_Tags || '—') + '</p></div>' +
        '</div>';

      lucide.createIcons();

      // Approve handler
      document.getElementById('approveBtn').addEventListener('click', async function () {
        this.disabled = true;
        try {
          await AppApi.updatePrompt(selectedPrompt.cr7b4_AI_Promptid, { cr7b4_PromptStatus: 100000002 });
          AppUI.showToast('Prompt approved!', 'success');
          setTimeout(function () { location.reload(); }, 600);
        } catch (err) {
          AppUI.showToast('Failed to approve.', 'error');
          this.disabled = false;
        }
      });

      // Reject handler
      document.getElementById('rejectBtn').addEventListener('click', function () {
        document.getElementById('rejectModal').classList.add('open');
      });
    });
  });

  // Reject modal
  document.getElementById('closeRejectModal').addEventListener('click', function () {
    document.getElementById('rejectModal').classList.remove('open');
  });
  document.getElementById('cancelReject').addEventListener('click', function () {
    document.getElementById('rejectModal').classList.remove('open');
  });
  document.getElementById('confirmReject').addEventListener('click', async function () {
    this.disabled = true;
    try {
      await AppApi.updatePrompt(selectedPrompt.cr7b4_AI_Promptid, { cr7b4_PromptStatus: 100000003 });
      document.getElementById('rejectModal').classList.remove('open');
      AppUI.showToast('Prompt rejected.', 'warning');
      setTimeout(function () { location.reload(); }, 600);
    } catch (err) {
      AppUI.showToast('Failed to reject.', 'error');
      this.disabled = false;
    }
  });

  lucide.createIcons();
});
</script>
{% endblock %}
