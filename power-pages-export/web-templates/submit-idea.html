{% extends "Layout" %}
{% block main %}
{% comment %}
  ============================================================
  Submit Idea Form
  ============================================================
{% endcomment %}

<div style="max-width:800px;margin:0 auto">
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-sm mb-lg text-sm text-muted">
    <a href="/ideas">Ideas Dashboard</a>
    <span>/</span>
    <span>Submit New Idea</span>
  </nav>

  <div class="card">
    <div class="card-header">
      <h1 style="font-size:var(--font-size-xl)">
        <i data-lucide="plus-circle" style="width:22px;height:22px;vertical-align:middle"></i>
        Submit a New AI Use Case Idea
      </h1>
    </div>
    <div class="card-body">
      <form id="submitIdeaForm" novalidate>
        <!-- Section: Idea Details -->
        <h3 class="mb-md" style="font-size:var(--font-size-lg)">Idea Details</h3>

        <div class="form-group">
          <label class="form-label" for="ideaTitle">Title *</label>
          <input type="text" id="ideaTitle" class="form-control" placeholder="e.g. Automated Audit Evidence Analysis" maxlength="200" required />
          <div class="form-error" id="errorTitle" style="display:none"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="ideaDescription">Description *</label>
          <textarea id="ideaDescription" class="form-control" rows="5" placeholder="Describe the AI use case, the problem it solves, and how it would work..." maxlength="2000" required></textarea>
          <div class="form-hint"><span id="descCharCount">0</span>/2000</div>
          <div class="form-error" id="errorDescription" style="display:none"></div>
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label" for="ideaCapability">AI Capability Area *</label>
            <select id="ideaCapability" class="form-control" required>
              <option value="">Select capability...</option>
            </select>
            <div class="form-error" id="errorCapability" style="display:none"></div>
          </div>
          <div class="form-group">
            <label class="form-label" for="ideaFunction">Business Function *</label>
            <select id="ideaFunction" class="form-control" required>
              <option value="">Select function...</option>
            </select>
            <div class="form-error" id="errorFunction" style="display:none"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="ideaBenefits">Expected Benefits *</label>
          <textarea id="ideaBenefits" class="form-control" rows="3" placeholder="Describe the expected benefits and impact..." maxlength="2000" required></textarea>
          <div class="form-error" id="errorBenefits" style="display:none"></div>
        </div>

        <hr style="border:none;border-top:1px solid var(--color-border);margin:var(--space-xl) 0" />

        <!-- Section: Your Information -->
        <h3 class="mb-md" style="font-size:var(--font-size-lg)">Your Information</h3>

        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label" for="submitterName">Your Name *</label>
            <input type="text" id="submitterName" class="form-control" placeholder="Full name" required
              {% if user %}value="{{ user.fullname }}"{% endif %} />
            <div class="form-error" id="errorName" style="display:none"></div>
          </div>
          <div class="form-group">
            <label class="form-label" for="submitterEmail">Your Email *</label>
            <input type="email" id="submitterEmail" class="form-control" placeholder="name@company.com" required
              {% if user %}value="{{ user.emailaddress1 }}"{% endif %} />
            <div class="form-error" id="errorEmail" style="display:none"></div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center" style="margin-top:var(--space-xl)">
          <a href="/ideas" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
            <i data-lucide="send" style="width:16px;height:16px"></i> Submit Idea
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Populate dropdowns
  var capSelect = document.getElementById('ideaCapability');
  AppData.AI_CAPABILITIES.forEach(function (c, idx) {
    var opt = document.createElement('option');
    opt.value = 100000000 + idx;
    opt.textContent = c;
    capSelect.appendChild(opt);
  });
  var funcSelect = document.getElementById('ideaFunction');
  AppData.BUSINESS_FUNCTIONS.forEach(function (f, idx) {
    var opt = document.createElement('option');
    opt.value = 100000000 + idx;
    opt.textContent = f;
    funcSelect.appendChild(opt);
  });

  // Character count
  document.getElementById('ideaDescription').addEventListener('input', function () {
    document.getElementById('descCharCount').textContent = this.value.length;
  });

  // Validation
  function validate () {
    var valid = true;
    var fields = [
      { id: 'ideaTitle', error: 'errorTitle', msg: 'Title is required' },
      { id: 'ideaDescription', error: 'errorDescription', msg: 'Description is required' },
      { id: 'ideaCapability', error: 'errorCapability', msg: 'Please select an AI capability area' },
      { id: 'ideaFunction', error: 'errorFunction', msg: 'Please select a business function' },
      { id: 'ideaBenefits', error: 'errorBenefits', msg: 'Expected benefits are required' },
      { id: 'submitterName', error: 'errorName', msg: 'Your name is required' },
      { id: 'submitterEmail', error: 'errorEmail', msg: 'A valid email is required' }
    ];
    fields.forEach(function (f) {
      var el = document.getElementById(f.id);
      var errEl = document.getElementById(f.error);
      var val = el.value.trim();
      if (!val || (f.id === 'submitterEmail' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val))) {
        el.classList.add('error');
        errEl.textContent = f.msg;
        errEl.style.display = '';
        valid = false;
      } else {
        el.classList.remove('error');
        errEl.style.display = 'none';
      }
    });
    return valid;
  }

  // Submit
  document.getElementById('submitIdeaForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!validate()) return;

    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
      var idCount = (await AppApi.getIdeas()).length + 1;
      var newId = 'IDEA-' + String(idCount).padStart(3, '0');

      await AppApi.createIdea({
        cr7b4_IdeaId: newId,
        cr7b4_Title: document.getElementById('ideaTitle').value.trim(),
        cr7b4_Description: document.getElementById('ideaDescription').value.trim(),
        cr7b4_AICapabilityArea: parseInt(document.getElementById('ideaCapability').value),
        cr7b4_BusinessFunction: parseInt(document.getElementById('ideaFunction').value),
        cr7b4_ExpectedBenefits: document.getElementById('ideaBenefits').value.trim(),
        cr7b4_SubmitterName: document.getElementById('submitterName').value.trim(),
        cr7b4_SubmitterEmail: document.getElementById('submitterEmail').value.trim(),
        cr7b4_Status: 100000000, // Submitted
        cr7b4_CreatedAt: new Date().toISOString()
      });

      AppUI.showToast('Idea submitted successfully!', 'success');
      setTimeout(function () { window.location.href = '/ideas'; }, 1200);
    } catch (err) {
      console.error('Submit error:', err);
      AppUI.showToast('Failed to submit idea. Please try again.', 'error');
      btn.disabled = false;
      btn.textContent = 'Submit Idea';
    }
  });
});
</script>
{% endblock %}
